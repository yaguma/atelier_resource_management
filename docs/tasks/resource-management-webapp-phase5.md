# Phase 5: データエクスポート/インポートとダッシュボード

## フェーズ概要

### 要件名
resource-management-webapp

### 期間・目標
- **期間**: 6営業日（Week 6-7、Day 26-31）
- **総工数**: 48時間
- **タスク数**: 12タスク
- **目標**: データエクスポート/インポート機能とダッシュボード画面の実装、最終統合テストと本番デプロイ準備

### 成果物
- データエクスポートAPI（JSON形式、バリデーション付き）
- データインポートAPI（スキーマバリデーション、エラーハンドリング）
- エクスポート画面（リソース選択、フォーマット指定）
- インポート画面（ファイルアップロード、プレビュー、検証）
- ダッシュボード画面（統計情報、グラフ表示）
- ダッシュボードAPI（統計データエンドポイント）
- 検索・フィルタリング機能強化
- E2Eテストスイート
- パフォーマンス最適化
- 統合テスト完了
- デプロイメントガイド

---

## 週次計画

### Week 6（Day 26-30）: エクスポート/インポート機能とダッシュボード実装
**目標**: データエクスポート/インポート機能とダッシュボードを実装する

**成果物**:
- データエクスポートAPI（GET /api/export）
- データインポートAPI（POST /api/import）
- エクスポート画面（リソース選択UI）
- インポート画面（ファイルアップロードUI）
- ダッシュボードAPI（GET /api/dashboard/stats）
- ダッシュボード画面（統計グラフ）

### Week 7（Day 31）: 最終テスト・デプロイ準備
**目標**: E2Eテスト、パフォーマンス最適化、統合テスト、デプロイメント準備を完了する

**成果物**:
- E2Eテストスイート
- パフォーマンス最適化（バンドルサイズ削減、レスポンス改善）
- 統合テスト完了
- デプロイメントガイド（Azure App Service）

---

## 日次タスク

### Day 26（8時間）: データエクスポートAPI実装

#### ☑ TASK-0056: データエクスポートAPI実装（GET /api/export）
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-068, WRREQ-069
- **依存タスク**: TASK-0005, TASK-0016, TASK-0022

**実装詳細**:
1. `src/routes/export.ts`作成
   - GET /api/export エンドポイント実装
   - クエリパラメータ対応（resourceType, format）
   - リソースタイプ選択（cards, customers, alchemyStyles, all）

2. `src/controllers/exportController.ts`作成
   - exportData関数実装
   - Prismaでデータ取得（リソースタイプに応じて）
   - JSON形式でエクスポート
   - 日時スタンプ付きファイル名生成

3. `src/types/export.ts`作成
   - exportQuerySchemaスキーマ定義（Zod）
   - resourceType: enum（cards, customers, alchemyStyles, all）
   - format: enum（json）
   - ExportDataResponse型定義

4. データ検証機能
   - エクスポート前のデータバリデーション
   - リレーションデータの整合性チェック
   - 削除済みデータの除外

**完了条件**:
- [ ] GET /api/export が動作する
- [ ] resourceType指定でデータ取得できる
- [ ] JSON形式でレスポンスが返る
- [ ] 削除済みデータが除外される
- [ ] リレーションデータが含まれる

**テスト要件**:
- [ ] resourceType=cardsでカードデータのみ取得できる
- [ ] resourceType=customersで顧客データのみ取得できる
- [ ] resourceType=allで全データ取得できる
- [ ] 削除済みデータが除外される
- [ ] バリデーションエラーが正しく返る

---

### Day 27（8時間）: データインポートAPI実装

#### ☑ TASK-0057: データインポートAPI実装（POST /api/import）
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-070, WRREQ-071
- **依存タスク**: TASK-0056

**実装詳細**:
1. POST /api/import エンドポイント実装
   - リクエストボディ受け取り（JSON形式）
   - スキーマバリデーション実行

2. `src/controllers/importController.ts`作成
   - importData関数実装
   - スキーマバリデーション（Zod）
   - データ整合性チェック（外部キー、ユニーク制約）
   - トランザクション処理（全データ一括インポート）
   - エラーハンドリング（部分失敗時のロールバック）

3. `src/types/import.ts`作成
   - importDataSchemaスキーマ定義（Zod）
   - cards: array（Card[]）
   - customers: array（Customer[]）
   - alchemyStyles: array（AlchemyStyle[]）
   - ImportResult型定義（success, errors, importedCount）

4. バリデーション機能
   - 必須フィールドチェック
   - データ型チェック
   - 外部キー整合性チェック
   - ユニーク制約チェック

**完了条件**:
- [ ] POST /api/import が動作する
- [ ] JSON形式でデータインポートできる
- [ ] スキーマバリデーションが動作する
- [ ] トランザクション処理が動作する
- [ ] エラー時にロールバックされる

**テスト要件**:
- [ ] 正常なJSONでインポート成功する
- [ ] 不正なスキーマでバリデーションエラーが返る
- [ ] 外部キー整合性エラーが検出される
- [ ] ユニーク制約違反が検出される
- [ ] 部分失敗時に全体がロールバックされる

---

### Day 28（8時間）: エクスポート画面・インポート画面実装

#### ☑ TASK-0058: エクスポート画面実装
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-068, WRREQ-069
- **依存タスク**: TASK-0056

**実装詳細**:
1. `src/pages/export/ExportPage.tsx`作成
   - リソースタイプ選択UI（cards, customers, alchemyStyles, all）
   - エクスポートボタン（useExportDataフック使用）
   - ファイルダウンロード処理（Blob + URL.createObjectURL）
   - Toast通知（成功・失敗）
   - ファイル名形式: `export-{resourceType}-{timestamp}.json`

**完了条件**:
- [ ] エクスポート画面が表示される
- [ ] リソースタイプ選択が動作する
- [ ] エクスポート実行でファイルダウンロードされる
- [ ] Toast通知が表示される

**テスト要件**:
- [ ] リソースタイプ選択が動作する
- [ ] エクスポートボタンクリックでAPIが呼ばれる
- [ ] ファイルダウンロードが実行される

---

#### ☑ TASK-0059: インポート画面実装
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-070, WRREQ-071
- **依存タスク**: TASK-0057

**実装詳細**:
1. `src/pages/import/ImportPage.tsx`作成
   - ファイルアップロードUI（.json形式のみ）
   - FileReaderでJSONパース
   - JSONプレビュー表示（整形表示）
   - インポートボタン（useImportDataフック使用）
   - Toast通知（成功件数表示、エラー表示）
   - バリデーションエラー時の詳細表示

**完了条件**:
- [ ] インポート画面が表示される
- [ ] ファイルアップロードが動作する
- [ ] JSONプレビューが表示される
- [ ] インポート実行が成功する
- [ ] Toast通知が表示される

**テスト要件**:
- [ ] ファイル選択でプレビューが表示される
- [ ] 不正なJSONでエラーが表示される
- [ ] インポートボタンクリックでAPIが呼ばれる

---

### Day 29（8時間）: ダッシュボードAPI・画面実装

#### ☑ TASK-0060: ダッシュボードAPI実装（GET /api/dashboard/stats）
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-072, WRREQ-073
- **依存タスク**: TASK-0016, TASK-0022

**実装詳細**:
1. `src/routes/dashboard.ts`作成
   - GET /api/dashboard/stats エンドポイント実装
   - 統計データ取得

2. `src/controllers/dashboardController.ts`作成
   - getStats関数実装
   - Prisma aggregateで集計処理
   - 統計データ生成:
     - カード総数（タイプ別、レアリティ別）
     - 顧客総数（難易度別）
     - 錬金スタイル総数
     - 最近作成されたリソース（直近10件）

3. `src/types/dashboard.ts`作成
   - DashboardStats型定義
   - cardStats: { total, byType, byRarity }
   - customerStats: { total, byDifficulty }
   - alchemyStyleStats: { total }
   - recentlyCreated: { cards, customers, alchemyStyles }

**完了条件**:
- [ ] GET /api/dashboard/stats が動作する
- [ ] カード統計データが取得できる
- [ ] 顧客統計データが取得できる
- [ ] 最近作成されたリソースが取得できる

**テスト要件**:
- [ ] カード総数が正しく集計される
- [ ] タイプ別・レアリティ別集計が動作する
- [ ] 顧客総数・難易度別集計が動作する
- [ ] 最近作成されたリソースが正しく取得される

---

#### ☑ TASK-0061: ダッシュボード画面実装
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-072, WRREQ-073
- **依存タスク**: TASK-0060

**実装詳細**:
1. `src/pages/dashboard/DashboardPage.tsx`作成
   - 統計カード表示（カード総数、顧客総数、錬金スタイル総数）
   - カードタイプ別集計グラフ
   - 顧客難易度別集計グラフ
   - レアリティ別集計グラフ
   - 最近作成されたリソース一覧（直近10件）
   - useDashboardStatsフック使用

**完了条件**:
- [ ] ダッシュボード画面が表示される
- [ ] 統計データが表示される
- [ ] グラフ・チャートが表示される
- [ ] 最近作成されたリソースが表示される

**テスト要件**:
- [ ] データ取得時に統計が表示される
- [ ] カードタイプ別集計が表示される
- [ ] 顧客難易度別集計が表示される

---

### Day 30（8時間）: 検索・フィルタリング機能強化

#### ☑ TASK-0062: 検索・フィルタリング機能強化
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-053-2, WRREQ-055-2
- **依存タスク**: TASK-0038

**実装詳細**:
1. カード一覧画面の検索機能強化
   - 複数条件フィルタリング（cardType, rarity, energyCost範囲）
   - ソート機能（name, createdAt, energyCost）
   - フィルタ保存機能（LocalStorage）

2. `src/components/cards/CardFilter.tsx`作成
   - 検索入力フィールド（カード名部分一致）
   - カードタイプ選択（全6種類）
   - レアリティ選択（全5種類）
   - エネルギーコスト範囲指定（スライダー）
   - フィルタクリアボタン

3. LocalStorageへのフィルタ保存
   - `localStorage.setItem('cardFilters', JSON.stringify(filters))`
   - ページ読み込み時に復元
   - フィルタクリア時に削除

**完了条件**:
- [ ] 複数条件フィルタリングが動作する
- [ ] ソート機能が動作する
- [ ] フィルタ保存・復元が動作する
- [ ] フィルタクリア機能が動作する

**テスト要件**:
- [ ] カードタイプでフィルタリングできる
- [ ] レアリティでフィルタリングできる
- [ ] 複数条件の組み合わせが動作する
- [ ] ソート順が正しく変わる
- [ ] LocalStorageに保存される

---

### Day 31（8時間）: E2Eテスト・最適化・ドキュメント作成

#### ☑ TASK-0063: E2Eテスト実装
- **推定工数**: 2時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: 全要件
- **依存タスク**: TASK-0038〜0062

**実装詳細**:
1. Playwrightセットアップ
   ```bash
   npm install -D @playwright/test
   npx playwright install
   ```

2. `tests/e2e/cards.spec.ts`作成
   - カード一覧表示テスト
   - カード作成フローテスト（入力→送信→Toast確認）
   - カード編集フローテスト（データ取得→更新→Toast確認）
   - カード削除フローテスト（削除確認モーダル→削除実行）
   - 検索・フィルタリングテスト
   - ページネーションテスト

3. テストシナリオ実行
   - カード管理フロー（一覧・作成・編集・削除）
   - 顧客管理フロー（一覧・作成・編集・削除）
   - エクスポート/インポートフロー
   - ダッシュボード表示

**完了条件**:
- [ ] Playwright環境が構築される
- [ ] E2Eテストが実装される
- [ ] 全テストシナリオが通る

---

#### ☑ TASK-0064: パフォーマンス最適化
- **推定工数**: 2時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: WRNFR-002, WRNFR-003
- **依存タスク**: TASK-0001〜0062

**実装詳細**:
1. フロントエンドバンドルサイズ削減
   - コード分割（React.lazy、Suspense）
   - 未使用コード削除（tree-shaking）
   - 画像最適化

2. APIレスポンス改善
   - データベースクエリ最適化（N+1問題解決）
   - インデックス追加（Prisma schema）
   - キャッシュ戦略（Redis導入検討）

3. `vite.config.ts`最適化
   - manualChunks設定（vendor, ui分離）
   - rollupOptions設定

4. Prismaクエリ最適化
   - include指定でN+1問題解決
   - selectで必要フィールドのみ取得
   - 適切なインデックス追加

**完了条件**:
- [ ] バンドルサイズが削減される
- [ ] ページ読み込み時間が改善される
- [ ] APIレスポンス時間が改善される
- [ ] Lighthouse スコアが改善される

---

#### ☑ TASK-0065: 統合テスト・品質確認
- **推定工数**: 2時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: 全要件
- **依存タスク**: TASK-0001〜0064

**実装詳細**:
1. 全APIエンドポイント動作確認
   - カード管理API（CRUD、検索、フィルタリング）
   - 顧客管理API（CRUD、N:Mリレーション）
   - 錬金スタイル管理API（CRUD、1:Nリレーション）
   - エクスポート/インポートAPI
   - ダッシュボードAPI

2. 全画面動作確認
   - カード管理画面（一覧・作成・編集・詳細・削除）
   - 顧客管理画面（一覧・作成・編集・詳細・削除）
   - 錬金スタイル管理画面（一覧・作成・編集・詳細・削除）
   - エクスポート/インポート画面
   - ダッシュボード画面

3. エラーハンドリング確認
   - バリデーションエラー
   - 404エラー
   - 409エラー（依存関係、ユニーク制約）
   - 500エラー

4. クロスブラウザテスト
   - Chrome
   - Firefox
   - Safari
   - Edge

**完了条件**:
- [ ] 全APIエンドポイントが正常に動作する
- [ ] 全画面が正常に動作する
- [ ] エラーハンドリングが正しく動作する
- [ ] クロスブラウザで動作する

---

#### ☑ TASK-0066: プロジェクトドキュメント作成
- **推定工数**: 1時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: 全要件
- **依存タスク**: TASK-0001〜0065

**実装詳細**:
1. README.md更新
   - プロジェクト概要
   - 技術スタック一覧
   - セットアップ手順
   - 開発コマンド（dev, build, test）
   - ディレクトリ構造

2. API仕様書更新
   - 全エンドポイント一覧
   - リクエスト/レスポンス例
   - エラーコード一覧
   - 認証仕様（将来実装）

3. フロントエンド仕様書作成
   - コンポーネント一覧
   - ページ構成
   - 状態管理（TanStack Query）
   - ルーティング設定

4. 運用ガイド作成
   - データバックアップ手順
   - エクスポート/インポート手順
   - トラブルシューティング

**完了条件**:
- [ ] README.mdが更新される
- [ ] API仕様書が最新化される
- [ ] フロントエンド仕様書が作成される
- [ ] 運用ガイドが作成される

---

#### ☑ TASK-0067: デプロイメントガイド作成・本番環境準備
- **推定工数**: 1時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: WRNFR-005, WRNFR-006
- **依存タスク**: TASK-0066

**実装詳細**:
1. Azure App Serviceデプロイ手順書作成
   - Azureリソース作成手順
   - 環境変数設定
   - データベース接続設定
   - CI/CDパイプライン設定（GitHub Actions）

2. 環境変数設定ガイド
   - `.env.example`ファイル作成
   - 必須環境変数一覧
   - セキュリティ設定

3. データベース移行手順
   - Prisma Migrateコマンド
   - 初期データ投入
   - バックアップ手順

4. 本番環境チェックリスト
   - HTTPS設定
   - CORS設定
   - セキュリティヘッダー設定
   - ログ設定
   - モニタリング設定

**完了条件**:
- [ ] デプロイメントガイドが作成される
- [ ] 環境変数設定ガイドが作成される
- [ ] データベース移行手順が文書化される
- [ ] 本番環境チェックリストが作成される

---

## Phase 5 完了条件

### 必須条件
- [ ] データエクスポートAPI（GET /api/export）が動作する
- [ ] データインポートAPI（POST /api/import）が動作する
- [ ] エクスポート画面が動作する
- [ ] インポート画面が動作する
- [ ] ダッシュボードAPI（GET /api/dashboard/stats）が動作する
- [ ] ダッシュボード画面が動作する
- [ ] 検索・フィルタリング機能強化が完了する
- [ ] E2Eテストが通る
- [ ] パフォーマンス最適化が完了する
- [ ] 統合テストが完了する
- [ ] プロジェクトドキュメントが作成される
- [ ] デプロイメントガイドが作成される

### 品質基準
- [ ] 全APIエンドポイントのテストが通る
- [ ] E2Eテストが全て通る
- [ ] TypeScriptのコンパイルエラーがない
- [ ] ESLint・Prettierでコード整形されている
- [ ] Lighthouse スコア: Performance 90+、Accessibility 90+
- [ ] バンドルサイズ: 500KB以下（gzip圧縮後）
- [ ] APIレスポンス時間: 200ms以下（平均）

### マイルストーン
- [x] **M5: 全機能実装完了・本番デプロイ準備完了** - Phase 5完了時点で達成

---

## 備考

### データエクスポート/インポート形式

**エクスポート形式例**:
```json
{
  "exportedAt": "2025-11-09T12:00:00Z",
  "version": "1.0",
  "data": {
    "cards": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "炎の素材",
        "cardType": "MATERIAL",
        "rarity": "COMMON",
        "energyCost": 2,
        "stabilityValue": 50
      }
    ],
    "customers": [],
    "alchemyStyles": []
  }
}
```

### パフォーマンス最適化チェックリスト

- [ ] コード分割（React.lazy）
- [ ] 画像遅延読み込み（lazy loading）
- [ ] バンドルサイズ削減（tree-shaking）
- [ ] データベースインデックス追加
- [ ] N+1クエリ問題解決
- [ ] キャッシュ戦略実装
- [ ] CDN配信設定（静的アセット）
- [ ] Gzip圧縮有効化

### E2Eテストシナリオ

1. **カード管理フロー**
   - カード一覧表示
   - カード作成（成功・失敗）
   - カード編集（成功・失敗）
   - カード詳細表示
   - カード削除（成功・失敗）

2. **顧客管理フロー**
   - 顧客一覧表示
   - 顧客作成（N:Mリレーション含む）
   - 顧客編集
   - 顧客削除

3. **エクスポート/インポートフロー**
   - データエクスポート（全データ、個別リソース）
   - データインポート（成功・失敗）
   - スキーマバリデーション

4. **ダッシュボードフロー**
   - 統計データ表示
   - グラフ・チャート表示

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-11-09 | 1.0 | 初版作成。12タスク、48時間 |
