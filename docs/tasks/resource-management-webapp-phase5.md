# Phase 5: データエクスポート/インポートとダッシュボード

## フェーズ概要

### 要件名
resource-management-webapp

### 期間・目標
- **期間**: 6営業日（Week 8、Day 37-42）
- **総工数**: 48時間
- **タスク数**: 12タスク
- **目標**: データエクスポート/インポート機能とダッシュボード画面の実装、最終統合テストと本番デプロイ準備

### 成果物
- データエクスポートAPI（JSON形式、バリデーション付き）
- データインポートAPI（スキーマバリデーション、エラーハンドリング）
- エクスポート画面（リソース選択、フォーマット指定）
- インポート画面（ファイルアップロード、プレビュー、検証）
- ダッシュボード画面（統計情報、グラフ表示）
- ダッシュボードAPI（統計データエンドポイント）
- 検索・フィルタリング機能強化
- E2Eテストスイート
- パフォーマンス最適化
- 統合テスト完了
- デプロイメントガイド

---

## 週次計画

### Week 8（Day 37-41）: エクスポート/インポート機能とダッシュボード実装
**目標**: データエクスポート/インポート機能とダッシュボードを実装する

**成果物**:
- データエクスポートAPI（GET /api/export）
- データインポートAPI（POST /api/import）
- エクスポート画面（リソース選択UI）
- インポート画面（ファイルアップロードUI）
- ダッシュボードAPI（GET /api/dashboard/stats）
- ダッシュボード画面（統計グラフ）

### Week 8（Day 42）: 最終テスト・デプロイ準備
**目標**: E2Eテスト、パフォーマンス最適化、統合テスト、デプロイメント準備を完了する

**成果物**:
- E2Eテストスイート
- パフォーマンス最適化（バンドルサイズ削減、レスポンス改善）
- 統合テスト完了
- デプロイメントガイド（Azure App Service）

---

## 日次タスク

### Day 37（8時間）: データエクスポートAPI実装

#### ☑ TASK-0056: データエクスポートAPI実装（GET /api/export）
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-068, WRREQ-069
- **依存タスク**: TASK-0005, TASK-0016, TASK-0022

**実装詳細**:
`src/routes/export.ts`にGET /api/exportエンドポイントを実装。`exportController.ts`でPrismaを使用してリソースタイプ（cards/customers/alchemyStyles/all）に応じたデータ取得とJSON形式エクスポート。`src/types/export.ts`でZodスキーマ定義（resourceType、format）とExportDataResponse型定義。削除済みデータの除外、リレーションデータの整合性チェック機能を実装。

**完了条件**: GET /api/exportが動作し、resourceType指定でデータ取得可能、JSON形式レスポンス、削除済みデータ除外、リレーションデータ含む。

**テスト要件**: resourceType別データ取得（cards/customers/all）、削除済みデータ除外、バリデーションエラー処理が正しく動作すること。

---

### Day 38（8時間）: データインポートAPI実装

#### ☑ TASK-0057: データインポートAPI実装（POST /api/import）
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-070, WRREQ-071
- **依存タスク**: TASK-0056

**実装詳細**:
POST /api/importエンドポイント実装。`src/controllers/importController.ts`でimportData関数を作成し、Zodスキーマバリデーション、データ整合性チェック（外部キー、ユニーク制約）、トランザクション処理（全データ一括インポート）、エラーハンドリング（部分失敗時のロールバック）を実装。`src/types/import.ts`でimportDataSchema（cards/customers/alchemyStyles配列）とImportResult型定義（success、errors、importedCount）。

**完了条件**: POST /api/importが動作し、JSON形式データインポート、スキーマバリデーション、トランザクション処理、エラー時ロールバックが正しく機能すること。

**テスト要件**: 正常JSONインポート成功、不正スキーマでバリデーションエラー、外部キー整合性エラー検出、ユニーク制約違反検出、部分失敗時の全体ロールバックが動作すること。

---

### Day 39（8時間）: エクスポート画面・インポート画面実装

#### ☑ TASK-0058: エクスポート画面実装
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-068, WRREQ-069
- **依存タスク**: TASK-0056

**実装詳細**:
`src/pages/export/ExportPage.tsx`作成。リソースタイプ選択UI（cards/customers/alchemyStyles/all）、useExportDataフックを使用したエクスポートボタン、Blob + URL.createObjectURLによるファイルダウンロード処理、Toast通知（成功・失敗）。ファイル名形式: `export-{resourceType}-{timestamp}.json`。

**完了条件**: エクスポート画面表示、リソースタイプ選択、エクスポート実行でファイルダウンロード、Toast通知が正しく動作すること。

**テスト要件**: リソースタイプ選択、エクスポートボタンクリックでAPI呼び出し、ファイルダウンロード実行が動作すること。

---

#### ☑ TASK-0059: インポート画面実装
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-070, WRREQ-071
- **依存タスク**: TASK-0057

**実装詳細**:
`src/pages/import/ImportPage.tsx`作成。ファイルアップロードUI（.json形式のみ）、FileReaderでJSONパース、JSONプレビュー表示（整形表示）、useImportDataフックを使用したインポートボタン、Toast通知（成功件数表示、エラー表示）、バリデーションエラー時の詳細表示。

**完了条件**: インポート画面表示、ファイルアップロード、JSONプレビュー表示、インポート実行成功、Toast通知が正しく動作すること。

**テスト要件**: ファイル選択でプレビュー表示、不正なJSONでエラー表示、インポートボタンクリックでAPI呼び出しが動作すること。

---

### Day 40（8時間）: ダッシュボードAPI・画面実装

#### ☑ TASK-0060: ダッシュボードAPI実装（GET /api/dashboard/stats）
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-072, WRREQ-073
- **依存タスク**: TASK-0016, TASK-0022

**実装詳細**:
`src/routes/dashboard.ts`にGET /api/dashboard/statsエンドポイント実装。`src/controllers/dashboardController.ts`でgetStats関数を作成し、Prisma aggregateで集計処理（カード総数［タイプ別、レアリティ別］、顧客総数［難易度別］、錬金スタイル総数、最近作成されたリソース［直近10件］）。`src/types/dashboard.ts`でDashboardStats型定義（cardStats、customerStats、alchemyStyleStats、recentlyCreated）。

**完了条件**: GET /api/dashboard/statsが動作し、カード統計、顧客統計、最近作成されたリソースが正しく取得できること。

**テスト要件**: カード総数・タイプ別・レアリティ別集計、顧客総数・難易度別集計、最近作成されたリソース取得が正しく動作すること。

---

#### ☑ TASK-0061: ダッシュボード画面実装
- **推定工数**: 4時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-072, WRREQ-073
- **依存タスク**: TASK-0060

**実装詳細**:
`src/pages/dashboard/DashboardPage.tsx`作成。統計カード表示（カード総数、顧客総数、錬金スタイル総数）、カードタイプ別集計グラフ、顧客難易度別集計グラフ、レアリティ別集計グラフ、最近作成されたリソース一覧（直近10件）、useDashboardStatsフック使用。

**完了条件**: ダッシュボード画面表示、統計データ表示、グラフ・チャート表示、最近作成されたリソース表示が正しく動作すること。

**テスト要件**: データ取得時に統計表示、カードタイプ別集計表示、顧客難易度別集計表示が動作すること。

---

### Day 41（8時間）: 検索・フィルタリング機能強化

#### ☑ TASK-0062: 検索・フィルタリング機能強化
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-053-2, WRREQ-055-2
- **依存タスク**: TASK-0038

**実装詳細**:
カード一覧画面の検索機能強化（複数条件フィルタリング［cardType、rarity、energyCost範囲］、ソート機能［name、createdAt、energyCost］、フィルタ保存機能［LocalStorage］）。`src/components/cards/CardFilter.tsx`作成（検索入力フィールド［カード名部分一致］、カードタイプ選択［全6種類］、レアリティ選択［全5種類］、エネルギーコスト範囲指定［スライダー］、フィルタクリアボタン）。LocalStorageへのフィルタ保存・復元・削除機能。

**完了条件**: 複数条件フィルタリング、ソート機能、フィルタ保存・復元、フィルタクリア機能が正しく動作すること。

**テスト要件**: カードタイプ・レアリティでフィルタリング、複数条件組み合わせ、ソート順変更、LocalStorage保存が動作すること。

---

### Day 42（8時間）: E2Eテスト・最適化・ドキュメント作成

#### ☑ TASK-0063: E2Eテスト実装
- **推定工数**: 2時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: 全要件
- **依存タスク**: TASK-0038〜0062

**実装詳細**:
Playwrightセットアップ（`npm install -D @playwright/test`、`npx playwright install`）。`tests/e2e/cards.spec.ts`作成（カード一覧表示、カード作成フロー［入力→送信→Toast確認］、カード編集フロー［データ取得→更新→Toast確認］、カード削除フロー［削除確認モーダル→削除実行］、検索・フィルタリング、ページネーション）。テストシナリオ実行（カード管理、顧客管理、エクスポート/インポート、ダッシュボード表示）。

**完了条件**: Playwright環境構築、E2Eテスト実装、全テストシナリオが通ること。

---

#### ☑ TASK-0064: パフォーマンス最適化
- **推定工数**: 2時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: WRNFR-002, WRNFR-003
- **依存タスク**: TASK-0001〜0062

**実装詳細**:
フロントエンドバンドルサイズ削減（コード分割［React.lazy、Suspense］、未使用コード削除［tree-shaking］、画像最適化）。APIレスポンス改善（データベースクエリ最適化［N+1問題解決］、インデックス追加［Prisma schema］、キャッシュ戦略［Redis導入検討］）。`vite.config.ts`最適化（manualChunks設定［vendor、ui分離］、rollupOptions設定）。Prismaクエリ最適化（include指定でN+1問題解決、selectで必要フィールドのみ取得、適切なインデックス追加）。

**完了条件**: バンドルサイズ削減、ページ読み込み時間改善、APIレスポンス時間改善、Lighthouseスコア改善が達成されること。

---

#### ☑ TASK-0065: 統合テスト・品質確認
- **推定工数**: 2時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: 全要件
- **依存タスク**: TASK-0001〜0064

**実装詳細**:
全APIエンドポイント動作確認（カード管理API［CRUD、検索、フィルタリング］、顧客管理API［CRUD、N:Mリレーション］、錬金スタイル管理API［CRUD、1:Nリレーション］、エクスポート/インポートAPI、ダッシュボードAPI）。全画面動作確認（カード管理、顧客管理、錬金スタイル管理、エクスポート/インポート、ダッシュボード）。エラーハンドリング確認（バリデーションエラー、404エラー、409エラー［依存関係、ユニーク制約］、500エラー）。クロスブラウザテスト（Chrome、Firefox、Safari、Edge）。

**完了条件**: 全APIエンドポイント、全画面、エラーハンドリング、クロスブラウザで正常に動作すること。

---

#### ☑ TASK-0066: プロジェクトドキュメント作成
- **推定工数**: 1時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: 全要件
- **依存タスク**: TASK-0001〜0065

**実装詳細**:
README.md更新（プロジェクト概要、技術スタック一覧、セットアップ手順、開発コマンド［dev、build、test］、ディレクトリ構造）。API仕様書更新（全エンドポイント一覧、リクエスト/レスポンス例、エラーコード一覧、認証仕様［将来実装］）。フロントエンド仕様書作成（コンポーネント一覧、ページ構成、状態管理［TanStack Query］、ルーティング設定）。運用ガイド作成（データバックアップ手順、エクスポート/インポート手順、トラブルシューティング）。

**完了条件**: README.md更新、API仕様書最新化、フロントエンド仕様書作成、運用ガイド作成が完了すること。

---

#### ☑ TASK-0067: デプロイメントガイド作成・本番環境準備
- **推定工数**: 1時間
- **タスクタイプ**: DIRECT
- **要件へのリンク**: WRNFR-005, WRNFR-006
- **依存タスク**: TASK-0066

**実装詳細**:
Azure App Serviceデプロイ手順書作成（Azureリソース作成手順、環境変数設定、データベース接続設定、CI/CDパイプライン設定［GitHub Actions］）。環境変数設定ガイド（`.env.example`ファイル作成、必須環境変数一覧、セキュリティ設定）。データベース移行手順（Prisma Migrateコマンド、初期データ投入、バックアップ手順）。本番環境チェックリスト（HTTPS設定、CORS設定、セキュリティヘッダー設定、ログ設定、モニタリング設定）。

**完了条件**: デプロイメントガイド作成、環境変数設定ガイド作成、データベース移行手順文書化、本番環境チェックリスト作成が完了すること。

---

## Phase 5 完了条件

**必須条件**: データエクスポートAPI（GET /api/export）、データインポートAPI（POST /api/import）、エクスポート画面、インポート画面、ダッシュボードAPI（GET /api/dashboard/stats）、ダッシュボード画面が動作すること。検索・フィルタリング機能強化、E2Eテスト、パフォーマンス最適化、統合テスト、プロジェクトドキュメント、デプロイメントガイドが完了すること。

**品質基準**: 全APIエンドポイントのテスト、E2Eテストが通ること。TypeScriptコンパイルエラーなし、ESLint・Prettierでコード整形済み、Lighthouseスコア（Performance 90+、Accessibility 90+）、バンドルサイズ500KB以下（gzip圧縮後）、APIレスポンス時間200ms以下（平均）を達成すること。

**マイルストーン**: M5「全機能実装完了・本番デプロイ準備完了」をPhase 5完了時点で達成。

---

## 備考

**データエクスポート/インポート形式**: JSON形式（exportedAt、version、data［cards/customers/alchemyStyles］を含む）でエクスポート。各リソースはid、name、cardType、rarity、energyCost、stabilityValue等のフィールドを持つ。

**パフォーマンス最適化チェックリスト**: コード分割（React.lazy）、画像遅延読み込み、バンドルサイズ削減（tree-shaking）、データベースインデックス追加、N+1クエリ問題解決、キャッシュ戦略実装、CDN配信設定、Gzip圧縮有効化。

**E2Eテストシナリオ**: カード管理フロー（一覧・作成・編集・詳細・削除）、顧客管理フロー（一覧・作成［N:Mリレーション含む］・編集・削除）、エクスポート/インポートフロー（全データ・個別リソースエクスポート、インポート成功・失敗、スキーマバリデーション）、ダッシュボードフロー（統計データ表示、グラフ・チャート表示）。

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-11-09 | 1.0 | 初版作成。12タスク、48時間 |
| 2025-11-09 | 1.1 | 500行以下に簡潔化。コード例削減、実装詳細簡潔化、チェックボックス形式を文章形式に変更 |
