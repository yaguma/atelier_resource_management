# Phase 4-A: 顧客管理画面

## フェーズ概要

### 要件名
resource-management-webapp

### 期間・目標
- **期間**: 5営業日（Week 6、Day 29-33）
- **総工数**: 40時間
- **タスク数**: 5タスク
- **目標**: 顧客管理画面（一覧・作成・編集・詳細・削除）を実装する

### 成果物
- 顧客管理画面（一覧・作成・編集・詳細・削除）
- N:Mリレーション UI（報酬カード選択）

---

## 週次計画

### Week 6（Day 29-33）: 顧客管理画面実装
**目標**: 顧客管理の全画面（一覧・作成・編集・詳細・削除）を実装する

**成果物**:
- 顧客一覧画面（ページネーション、検索、フィルタリング）
- 顧客作成画面（フォーム、N:Mリレーション、バリデーション）
- 顧客編集画面（既存データ取得、N:Mリレーション更新）
- 顧客詳細画面（読み取り専用表示、報酬カード表示）
- 顧客削除機能（モーダル確認、削除実行）

---

## 日次タスク

### Day 29（8時間）: 顧客一覧画面

#### ☑ TASK-0043: 顧客一覧画面実装
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-021, WRREQ-022, WRREQ-025
- **依存タスク**: TASK-0029, TASK-0030, TASK-0035, TASK-0036, TASK-0037

**実装詳細**:
1. `src/pages/customers/CustomerListPage.tsx`作成
   - TanStack Queryの`useCustomers`フックを使用してデータ取得
   - ページネーション、検索、難易度フィルタリング機能を実装
   - テーブル形式で顧客一覧を表示（名前、タイプ、難易度、報酬、操作ボタン）
   - 新規作成ボタン、詳細・編集リンクを配置

2. `src/hooks/useCustomers.ts`作成
   - TanStack Queryの`useQuery`、`useMutation`を使用
   - `useCustomers`: 一覧取得フック（ページング、検索、フィルタリングパラメータ対応）
   - `useCustomer`: 詳細取得フック
   - `useCreateCustomer`: 作成ミューテーション
   - `useUpdateCustomer`: 更新ミューテーション
   - `useDeleteCustomer`: 削除ミューテーション
   - 各ミューテーション成功時にクエリキャッシュを無効化

3. `src/api/customers.ts`作成
   - `getCustomers`: GET /api/customers（ページング、検索、フィルタリングパラメータ対応）
   - `getCustomer`: GET /api/customers/:id
   - `createCustomer`: POST /api/customers
   - `updateCustomer`: PUT /api/customers/:id
   - `deleteCustomer`: DELETE /api/customers/:id

4. `src/types/customer.ts`作成
   - Zodスキーマ定義（`createCustomerSchema`、`updateCustomerSchema`）
   - バリデーションルール: 顧客名（1〜100文字）、説明（1〜1000文字）、顧客タイプ（1〜50文字）、難易度（1〜5）、品質条件（0〜100）、安定性条件（0〜100）、報酬名声（0〜1000）、報酬知識（0〜1000）、報酬カードID配列
   - TypeScript型定義（`Customer`、`CreateCustomerInput`、`UpdateCustomerInput`）

**完了条件**: 顧客一覧が表示され、ページネーション、検索機能（名前）、難易度フィルタリングが動作すること。新規作成、詳細、編集リンクが正しく動作すること。

**テスト要件**: データ取得時に顧客が表示されること、検索入力でフィルタリングされること、難易度選択でフィルタリングされること、ページネーションボタンでページが切り替わることをテストする。

---

### Day 30（8時間）: 顧客作成画面

#### ☑ TASK-0044: 顧客作成画面実装（N:Mリレーション対応）
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-021, WRREQ-022, WRREQ-023, WRREQ-024, WRREQ-026
- **依存タスク**: TASK-0043

**実装詳細**:
1. `src/pages/customers/CustomerCreatePage.tsx`作成
   - React Hook Form + Zodバリデーションを使用したフォーム実装
   - `useCreateCustomer`ミューテーションフックを使用
   - `useCards`フックで報酬カード一覧を取得
   - 基本情報入力フィールド: 顧客名、説明、顧客タイプ、難易度、品質条件、安定性条件、報酬名声、報酬知識
   - 報酬カード選択UI: チェックボックスリストで複数カード選択可能（N:Mリレーション対応）
   - Toast通知機能を統合（成功・エラー通知）
   - 作成成功後に一覧画面へ遷移
   - キャンセルボタンで一覧画面へ戻る

**完了条件**: 顧客作成フォームが表示され、バリデーションが動作すること。報酬カード選択UI（チェックボックス）が動作し、顧客作成が成功すること。Toast通知が表示され、作成後に一覧画面に遷移すること。

**テスト要件**: フォーム送信でAPIが呼ばれること、バリデーションエラーが表示されること、報酬カード選択でN:M関連付けができること、作成成功でToast通知が表示されることをテストする。

---

### Day 31（8時間）: 顧客編集画面

#### ☑ TASK-0045: 顧客編集画面実装（N:Mリレーション対応）
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-021, WRREQ-022, WRREQ-024, WRREQ-026
- **依存タスク**: TASK-0044

**実装詳細**:
1. `src/pages/customers/CustomerEditPage.tsx`作成
   - CustomerCreatePageと類似の構造
   - `useParams`でURLからIDを取得
   - `useCustomer`フックで既存顧客データを取得
   - `useEffect`でフォームに既存データを設定（`reset`メソッド使用）
   - 報酬カード選択状態を既存データから復元
   - `useUpdateCustomer`ミューテーションフックで更新
   - Toast通知機能を統合
   - 更新成功後に一覧画面へ遷移
   - データ取得中はローディング表示

**完了条件**: 既存顧客データが取得され、フォームに既存データが表示されること。既存の報酬カード選択状態が復元され、顧客更新が成功すること。Toast通知が表示され、更新後に一覧画面に遷移すること。

**テスト要件**: 既存データでフォームが初期化されること、フォーム送信で更新APIが呼ばれること、報酬カード選択の変更が反映されること、更新成功でToast通知が表示されることをテストする。

---

### Day 32（8時間）: 顧客詳細画面

#### ☑ TASK-0046: 顧客詳細画面実装
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-021, WRREQ-022, WRREQ-023, WRREQ-024, WRREQ-025
- **依存タスク**: TASK-0043, TASK-0044

**実装詳細**:
1. `src/pages/customers/CustomerDetailPage.tsx`作成
   - `useParams`でURLからIDを取得
   - `useCustomer`フックで顧客詳細データを取得
   - 読み取り専用の詳細情報表示: 顧客名、説明、顧客タイプ、難易度（星表示）、品質条件、安定性条件、報酬名声、報酬知識
   - 報酬カード一覧をタグ形式で表示（各カードからカード詳細へのリンク付き）
   - 報酬カードがない場合は「報酬カードなし」と表示
   - 編集ボタン（編集画面へ遷移）
   - 一覧に戻るボタン
   - データ取得中はローディング表示
   - エラー発生時はエラーメッセージ表示
   - 顧客が見つからない場合は「顧客が見つかりません」と表示

**完了条件**: 顧客詳細が表示され、全フィールドが正しく表示されること。報酬カード一覧が表示され、報酬カードからカード詳細へのリンクが動作すること。編集ボタン、一覧に戻るボタンが動作すること。

**テスト要件**: データ取得時に顧客詳細が表示されること、存在しないIDでエラーメッセージが表示されること、報酬カードが正しく表示されることをテストする。

---

### Day 33（8時間）: 顧客削除機能

#### ☑ TASK-0047: 顧客削除機能実装
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件へのリンク**: WRREQ-026
- **依存タスク**: TASK-0046

**実装詳細**:
1. `src/pages/customers/CustomerDetailPage.tsx`に削除機能追加
   - 削除ボタンを配置（危険色のボタン）
   - 削除確認モーダル実装（Modalコンポーネント使用）
   - モーダル内容: 「本当にこの顧客を削除しますか？この操作は取り消せません。」
   - モーダルフッター: キャンセルボタン、削除ボタン
   - `useState`でモーダル開閉状態を管理
   - `useDeleteCustomer`ミューテーションフックで削除実行
   - 削除実行中はボタンにローディング表示
   - Toast通知機能を統合
   - 削除成功後に一覧画面へ遷移
   - キャンセルボタンでモーダルを閉じる

**完了条件**: 削除ボタンが表示され、削除確認モーダルが表示されること。顧客削除が成功し、Toast通知が表示されること。削除後に一覧画面に遷移すること。

**テスト要件**: 削除ボタンクリックでモーダルが表示されること、モーダル内の削除ボタンで削除APIが呼ばれること、削除成功でToast通知が表示されること、キャンセルボタンでモーダルが閉じることをテストする。

---

## Phase 4-A 完了条件

### 必須条件
- 顧客管理画面（一覧・作成・編集・詳細・削除）が動作すること
- 顧客作成・編集時にN:M関連（報酬カード）が正しく動作すること
- フォームバリデーション（Zod）が正しく動作すること
- Toast通知が正しく表示されること

### 品質基準
- ESLint・Prettierでコード整形されていること
- TypeScriptのコンパイルエラーがないこと
- 全テストが通ること
- TanStack Query Devtoolsで状態確認できること
- N:Mリレーション（報酬カード）が正しく動作すること

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-11-09 | 1.0 | Phase 4から分割。5タスク、40時間 |
